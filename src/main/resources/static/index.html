<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { border: 1px solid #ccc; background: #f9f9f9; }
        .info { margin-bottom: 10px; color: #666; }
    </style>
</head>
<body>
<div class="info">Real-time Page Analytics - Home, About, Services, Pricing</div>
<canvas id="chart2" width="800" height="400"></canvas>

<script>
    // Updated to include all four pages
    var pages = ["Home", "About", "Services", "Pricing"];
    var colors = [
        { stroke: 'rgba(0, 255, 0, 1)', fill: 'rgba(0, 255, 0, 0.2)' },
        { stroke: 'rgba(255, 0, 0, 1)', fill: 'rgba(255, 0, 0, 0.2)' },
        { stroke: 'rgba(0, 0, 255, 1)', fill: 'rgba(0, 0, 255, 0.2)' },
        { stroke: 'rgba(255, 165, 0, 1)', fill: 'rgba(255, 165, 0, 0.2)' }
    ];

    var courbe = [];
    var smoothieChart = new SmoothieChart({
        tooltip: true,
        grid: { strokeStyle: 'rgba(119, 119, 119, 0.18)', fillStyle: 'rgba(255, 255, 255, 0.1)', lineWidth: 1, millisPerLine: 1000, verticalSections: 6 },
        labels: { fillStyle: 'rgb(60, 60, 60)' },
        millisPerPixel: 20,
        maxValueScale: 1.1,
        minValueScale: 1.1,
        timestampFormatter: SmoothieChart.timeFormatter
    });

    // Initialize time series for each page
    pages.forEach(function(page, index) {
        courbe[page] = new TimeSeries();
        var color = colors[index % colors.length];
        smoothieChart.addTimeSeries(courbe[page], {
            strokeStyle: color.stroke,
            fillStyle: color.fill,
            lineWidth: 3
        });
    });

    // Stream to canvas
    smoothieChart.streamTo(document.getElementById("chart2"), 1000);

    console.log("Starting EventSource connection to /analytics...");
    console.log("Tracking pages:", pages);

    var stockEventSource = new EventSource("/analytics");

    stockEventSource.onopen = function(event) {
        console.log("Connection to analytics opened");
    };

    stockEventSource.onmessage = function(event) {
        try {
            var data = JSON.parse(event.data);
            console.log("Received data:", data);

            var timestamp = new Date().getTime();

            pages.forEach(function(page) {
                var value = data[page] || 0;  // Use 0 if page not in data
                courbe[page].append(timestamp, value);
            });

        } catch (error) {
            console.error("Error processing event:", error, "Raw data:", event.data);
        }
    };

    stockEventSource.onerror = function(event) {
        console.error("EventSource error:", event);
    };

</script>
</body>
</html>